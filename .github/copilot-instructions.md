# Learnify - AI Agent Instructions

## Project Overview
**Learnify** is a Next.js educational platform enabling educators to generate, verify, and deploy AI-assisted course content. Users can create structured courses with chapters and topics, which are auto-generated using Google's Gemini API, then verified by professors before publication to learners.

## Architecture

### Core Data Model
- **Users**: Sign-up/login with bcrypt-hashed passwords, stored in `usersTable`
- **Courses**: Owned by creator (userEmail), include nested JSON structure (`courseJson`), and track review workflow states
- **Auth Sessions**: Token-based, stored in `authSessionsTable` with token hash and expiration
- **Professors**: Verification team members with expertise areas
- **Enrollments**: Track which users have enrolled in courses and completed chapters

**Key Pattern**: All tables use `userEmail` as the cross-cutting foreign key for authorization checks.

### Review/Verification Workflow
Courses transition through states:
1. `draft` → User creates course, generates content via Gemini API
2. `pending_verification` → User requests professor review (generates `reviewTokenHash`)
3. `needs_changes` | `verified` → Professor reviews via email token link, provides feedback
4. Only verified courses appear to learners; content regeneration blocked in pending state

See [config/schema.js](config/schema.js) for full schema including `reviewStatus`, `reviewTokenHash`, `reviewFeedback` fields.

## Tech Stack & Key Integrations

| Layer | Tech | Pattern |
|-------|------|---------|
| **Frontend** | React 19, Next.js 16, Tailwind CSS | App Router (files in `app/`), client components marked `"use client"` |
| **UI** | Radix UI primitives + shadcn/ui | Accordion, Dialog, Select, Switch (in `components/ui/`) |
| **Database** | PostgreSQL (Neon), Drizzle ORM | Query builder syntax, migrations in `drizzle/` |
| **Auth** | Custom token-based | Session tokens hashed with MD5 (see [lib/session.js](lib/session.js)), stored in cookies |
| **AI Content** | Google Gemini API (gemini-2.0-flash) | Generates HTML content from chapter/topic JSON |
| **Notifications** | Nodemailer | Verification emails sent on course submission |

## Critical Developer Workflows

### Local Development
```bash
npm run dev              # Start Next.js dev server on :3000
npm run db:push         # Push schema changes to Neon DB
```

### Database Management
- Use `drizzle-kit studio` for interactive DB inspection (requires `DATABASE_URL` env var)
- Migrations auto-tracked in [drizzle/](drizzle/)
- Scripts in `scripts/` perform manual DB inspections (not integrated into build)

### Environment Setup
Required env vars:
- `DATABASE_URL` – PostgreSQL connection (Neon serverless)
- `GEMINI_API_KEY` – Google Generative AI key
- `NEXTAUTH_SECRET` – Session secret (if using auth library)

## Project-Specific Conventions

### Context API Usage
User and chapter state managed via React Context:
- [context/UserDetailContext.jsx](context/UserDetailContext.jsx) – Current user object
- [context/SelectedChapterIndexContext.jsx](context/SelectedChapterIndexContext.jsx) – Active chapter in course view
- Both initialized in [app/provider.jsx](app/provider.jsx) and wrapped around app tree

Call `LoadMe()` on mount to fetch user from `/api/auth/me` if needed.

### API Route Patterns
- Input validation mandatory (check body fields, normalize emails to lowercase)
- Auth: Use `getUserEmailFromRequestAsync()` from [lib/authServer.js](lib/authServer.js) to extract email from session cookie
- Error handling: Return `NextResponse.json({error: 'message'}, {status: code})`
- PostgreSQL constraint violations (`code: '23505'`) caught and mapped to 409 responses

Example: [app/api/auth/sign-up/route.jsx](app/api/auth/sign-up/route.jsx)

### Course JSON Structure
Courses store layout in `courseJson`:
```javascript
{
  course: { name, description, level, category, noOfChapters },
  chapters: [
    { chapterName, topics: [{topic, description}] }
  ]
}
```
Content generated by Gemini and merged into `courseContent` JSON field post-generation.

### UI Component Library
All interactive UI uses shadcn/ui (Radix + Tailwind). Extend with utility class `cn()` from [lib/utils.js](lib/utils.js):
```jsx
import { cn } from '@/utils'
<div className={cn('base-classes', isActive && 'active-classes')} />
```

### Authorization Pattern
**Cross-cutting concern**: Every API route must verify `userEmail` matches request sender:
```javascript
const userEmail = await getUserEmailFromRequestAsync(req);
const course = await db.select().from(coursesTable)
  .where(and(eq(coursesTable.cid, courseId), eq(coursesTable.userEmail, userEmail)))
```
Never trust `courseId` or `userId` from request body alone.

## Critical Integration Points

### Gemini Content Generation
- Triggered by `/api/generate-course-content` on user request
- Sends chapter structure → Gemini returns HTML-formatted topic content
- Response parsed as JSON with `chapterName` + `topics` array
- Merged into `courseContent` field; blocks regeneration if course pending verification

### Email Verification Flow
- Verification token generated and emailed when course submitted for review
- Token validated by professor clicking email link → routes to [app/verify/[token]/page.jsx](app/verify/[token]/page.jsx)
- Token hash checked against `reviewTokenHash` in DB

### Course Enrollment
- `/api/enroll-course` creates `enrollCourseTable` entry linking user to course
- Tracks `completedChapters` as user progresses
- Users access owned courses via `/workspace/edit-course/[courseId]` and enrolled courses via `/course/[courseId]`

## File Organization Highlights

| Path | Purpose |
|------|---------|
| `app/` | App Router pages, layouts, API routes |
| `app/workspace/` | User dashboard: create, edit, explore, my-learning |
| `app/course/[courseId]/` | Course view (learner mode) with chapter sidebar |
| `lib/` | Auth utilities, session management, utilities |
| `config/` | Database connection and schema definitions |
| `context/` | React Context for global state (user, selected chapter) |
| `components/ui/` | shadcn/ui component library |

## Common Tasks & Patterns

- **Add API endpoint**: Create route file in `app/api/`, extract userEmail, query DB with Drizzle, return JSON
- **Add course field**: Update schema in [config/schema.js](config/schema.js), run `npm run db:push`
- **Modify form**: Use shadcn form components, ensure email normalization (lowercase), validate on client + server
- **Permission check**: Always verify `userEmail` matches DB record owner before mutation
